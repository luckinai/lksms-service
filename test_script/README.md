# LKSMS Service 测试脚本

本目录包含LKSMS服务的测试脚本，用于验证API功能的正确性。

## 📋 测试脚本说明

### test_api.py
完整的API功能测试脚本，包含以下测试用例：

1. **健康检查** - 验证服务是否正常运行
2. **创建模板** - 测试短信模板创建功能
3. **创建默认短信内容** - 测试默认内容管理
4. **发送短信（带内容）** - 测试直接内容发送
5. **发送短信（使用模板）** - 测试模板参数化发送
6. **发送短信（默认内容）** - 测试默认内容发送
7. **查询任务状态** - 测试任务状态查询
8. **获取待处理任务** - 测试APP轮询功能
9. **汇报发送结果** - 测试结果汇报功能

## 🚀 使用方法

### 前提条件
确保LKSMS服务已启动并运行在指定端口。

### 基本用法
```bash
# 使用默认配置测试
python test_script/test_api.py

# 自定义服务地址
python test_script/test_api.py http://localhost:8000

# 自定义认证信息
python test_script/test_api.py http://localhost:8000 admin your_password
```

### Docker环境测试
```bash
# 启动服务
docker-compose up -d

# 等待服务启动完成
sleep 10

# 运行测试
python test_script/test_api.py http://localhost:8000 admin your_secure_password
```

## 📊 测试结果

脚本会输出详细的测试过程和结果：

```
🚀 开始LKSMS API测试
============================================================

🏥 测试健康检查
==================================================
🔄 GET http://localhost:8000/health
📥 Response [200]: {"status":"healthy","service":"lksms-service"}

...

📊 测试结果汇总
============================================================
健康检查              ✅ 通过
创建模板              ✅ 通过
创建默认短信内容       ✅ 通过
发送短信（带内容）     ✅ 通过
发送短信（使用模板）   ✅ 通过
发送短信（默认内容）   ✅ 通过
查询任务状态          ✅ 通过
获取待处理任务        ✅ 通过
汇报发送结果（成功）   ✅ 通过
汇报发送结果（失败）   ✅ 通过

总计: 10/10 个测试通过
🎉 所有测试通过！
```

## 🔧 自定义测试

你可以修改`test_api.py`中的测试数据来适应你的需求：

```python
# 修改测试手机号
data = {
    "phone_number": "你的测试手机号",
    "content": "你的测试内容",
    ...
}

# 修改认证信息
tester = LKSMSAPITester(
    base_url="http://your-server:8000",
    username="your_username", 
    password="your_password"
)
```

## 🐛 故障排除

### 常见问题

1. **连接失败**
   - 检查服务是否启动
   - 确认端口号是否正确
   - 检查防火墙设置

2. **认证失败**
   - 确认用户名密码是否正确
   - 检查.env文件配置

3. **数据库错误**
   - 确认PostgreSQL服务是否运行
   - 检查数据库连接配置
   - 确认数据库表是否已创建

### 调试模式

在测试脚本中添加更多调试信息：

```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

## 📝 测试数据

测试脚本会创建以下测试数据：

- **模板**: "您的验证码是{code}，用户{name}，请在{time}分钟内使用。"
- **默认内容**: 
  - 13900139001: 使用模板的参数化内容
  - 13900139002: 固定文本内容
- **测试任务**: 多个不同类型的发送任务

测试完成后，这些数据会保留在数据库中，可以通过数据库管理工具查看。
